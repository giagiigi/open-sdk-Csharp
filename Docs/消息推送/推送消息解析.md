## 推送消息处理

### 消息结构体

| 字段         | 类型      | 释义                                       |
| ---------- | ------- | ---------------------------------------- |
| mode       | number  | 1-自用型/工具型/平台型消息；0-签名模式消息                     |
| id         | String  | 业务消息的标识: 如 订单消息为订单编号,会员卡消息为会员卡id标识                    |
| client_id  | String  | 对应开发者后台的client_id                        |
| type       | enum    | 消息业务类型：TRADE_ORDER_STATE-订单状态事件，TRADE_ORDER_REFUND-退款事件，TRADE_ORDER_EXPRESS-物流事件，ITEM_STATE-商品状态事件，ITEM_INFO-商品基础信息事件，POINTS-积分，SCRM_CARD-会员卡（商家侧），SCRM_CUSTOMER_CARD-会员卡（用户侧），TRADE-交易V1，ITEM-商品V1        |
| msg        | String  | 经过unicode（UTF-8）编码的消息对象，具体参数请看本页中各业务消息结构文档   |
| kdt_id     | number  | 店铺ID                                   |
| sign       | String  | 防伪签名 ：MD5(client_id+msg+client_secrect)  |
| version    | long    | 消息版本号，为了解决顺序性的问题 ，高版本覆盖低版本               |
| test       | boolean | false-非测试消息，true- 测试消息 ；PUSH服务会定期通过发送测试消息检查开发者服务是否正常 |
| send_count | number  | 重发的次数                                    |

消息解析步骤
``` json
1. 判断消息是否测试  —> 解析 test
2. 判断消息推送的模式 —> 解析 mode
3. 判断消息是否伪造 —> 解析 sign
4. 判断消息版本  —> 解析 version
5. 判断消息的业务 —> 解析 type
6. 处理消息体 —> 解码 msg ，反序列化消息结构体
7. 返回接收成功标识 {"code":0,"msg":"success"}
```

### 推送规则
1、消息推送服务通过 POST 、参数编码为 APPLICATION/JSON (输入流)的方式向开发者提供的地址推送消息。
2、开发者接收到消息后必须返回 {"code":0,"msg":"success"} 通知有赞云成功接收。由于有赞云服务端响应超时时间为5s，建议开发者接收到消息后立即返回成功code，再异步去处理自有的业务信息。
3、当推送没有成功返回（超时时间为5s），会进入重发。最多重发三次， 分别间隔10s、30s、60s。若三次重发后还是失败，则该消息丢弃。
4、当某个推送网址服务连续失败25次时 (一条消息失败后重发的次数不计算在内)，该推送网址会被添加到亚健康列表中。亚健康状态的推送网址将无法接收到消息，并且期间产生的消息会被丢弃。
5、有赞云会每隔30min检查亚健康列表中的商家服务是否恢复正常，正常的服务会被从该列表中移除。心跳检查的消息内容为 {"test": true}。

### 下载 DEMO

[Java](http://77g239.com1.z0.glb.clouddn.com/PushDemo.java.zip)

[PHP](http://77g239.com1.z0.glb.clouddn.com/PushDemo.php.zip)